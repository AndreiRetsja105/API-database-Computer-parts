<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sign & Verify</title>
  <link rel="stylesheet" href="css/Sign&Verify.css" />
</head>
<body>
  <div class="container1">
    <nav>
      <div class="logo">
        <a href="index.html">Computer Components API</a>
      </div>
      <ul>
        <li><a href="./secure-storage.html">Secure Storage</a></li>
        <li><a href="ComputerComponentLIst.html">Computer Component List</a></li>
        <li><a href="ChartForJason.html">Chart Bar chart</a></li>
      </ul>
    </nav>
  </div>

  <main class="shell">
    <h1 class="page-title">Document Signing <span class="tag">ECDSA P-256 / SHA-256</span></h1>

    <div class="grid-2">
      <!-- LEFT CARD: Keys -->
      <section class="card">
        <h2 class="card-title">Generate / Import Keys</h2>

        <div class="row actions">
          <button id="gen" class="btn btn-green">Generate keypair</button>
          <button id="export" class="btn btn-blue">Export keys</button>
        </div>

        <div class="row">
          <label class="label">Import Private Key (.pk8)</label>
          <input type="file" id="privIn" accept=".pk8" class="input input-file" />
        </div>

        <div class="row">
          <label class="label">Import Public Key (.spki)</label>
          <input type="file" id="pubIn" accept=".spki" class="input input-file" />
        </div>

        <div id="sv-log" class="result-box" aria-live="polite"></div>
      </section>

      <!-- RIGHT CARD: Sign & Verify -->
      <section class="card">
        <h2 class="card-title">Sign & Verify</h2>

        <div class="row">
          <label class="label">File to sign</label>
          <input type="file" id="fileToSign" class="input input-file" />
          <button id="sign" class="btn btn-indigo">Sign</button>
        </div>

        <hr class="divider" />

        <div class="row">
          <label class="label">File to verify</label>
          <input type="file" id="fileToVerify" class="input input-file" />
        </div>

        <div class="row">
          <label class="label">Signature file (.sig)</label>
          <input type="file" id="sigFile" accept=".sig" class="input input-file" />
        </div>

        <div class="row actions">
          <button id="verify" class="btn btn-purple">Verify</button>
        </div>

        <div id="verifyOut" class="result-box"></div>
      </section>
    </div>
  </main>

	<script type="module">
	import { enc, b64, ub64, genEcdsaKeyPair, ecdsaSign, ecdsaVerify, exportSpki, exportPkcs8, importSpki, importPkcs8, download } from './js/crypto-utils.js';

	let priv = null, pub = null;

	const log = msg => document.getElementById('sv-log').textContent += `\n${msg}`;

	document.getElementById('gen').addEventListener('click', async ()=>{
		({ publicKey: pub, privateKey: priv } = await genEcdsaKeyPair());
		log('Generated ECDSA P-256 keypair.');
	});

	document.getElementById('export').addEventListener('click', async ()=>{
		if(!priv||!pub){ log('No keys to export.'); return; }
		const spki = await exportSpki(pub); download('public.spki', spki);
		const pk8 = await exportPkcs8(priv); download('private.pk8', pk8);
		log('Exported public.spki and private.pk8');
	});

	document.getElementById('privIn').addEventListener('change', async (e)=>{
		const f = e.target.files[0]; if(!f) return; const buf = new Uint8Array(await f.arrayBuffer());
		priv = await importPkcs8(buf); log('Imported private key');
	});

	document.getElementById('pubIn').addEventListener('change', async (e)=>{
		const f = e.target.files[0]; if(!f) return; const buf = new Uint8Array(await f.arrayBuffer());
		pub = await importSpki(buf); log('Imported public key');
	});

	document.getElementById('sign').addEventListener('click', async ()=>{
		if(!priv){ alert('Import or generate a private key first.'); return; }
		const f = document.getElementById('fileToSign').files[0]; if(!f){ alert('Pick a file'); return; }
		const data = new Uint8Array(await f.arrayBuffer());
		const sig = await ecdsaSign(priv, data);
		download(`${f.name}.sig`, sig);
		log(`Signed ${f.name} → ${f.name}.sig`);
	});

	document.getElementById('verify').addEventListener('click', async ()=>{
		if(!pub){ alert('Import a public key (.spki)'); return; }
		const f = document.getElementById('fileToVerify').files[0];
		const sf = document.getElementById('sigFile').files[0];
		if(!f||!sf){ alert('Pick file and signature'); return; }
		const data = new Uint8Array(await f.arrayBuffer());
		const sig = new Uint8Array(await sf.arrayBuffer());
		const ok = await ecdsaVerify(pub, data, sig);
		document.getElementById('verifyOut').textContent = ok ? '✅ Signature valid' : '❌ Signature invalid';
	});
	</script>
</body>
</html>