<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Password Manager</title>
  <link rel="stylesheet" href="css/style2.css"/>
  <link rel="stylesheet" href="css/style3.css"/>
  <link rel="stylesheet" href="css/style1.css"/>
</head>
<body>
  <main>
    <div class="pm-wrapper">
      <h1 class="pm-title">Password Manager</h1>

      <!-- Auth card -->
      <section id="auth" class="pm-card">
        <h2>Register / Login</h2>

        <!-- Register -->
        <div class="pm-row" style="gap:8px;flex-wrap:wrap">
          <input id="reg-username" placeholder="New username" class="pm-input"/>
          <input id="reg-email" placeholder="Email (for activation)" type="email" class="pm-input"/>
          <input id="reg-password" placeholder="Master Password" type="password" class="pm-input"/>
          <button id="btn-register" class="pm-btn pm-btn-green">Register</button>
        </div>

        <hr style="margin:16px 0;opacity:.3"/>

        <!-- Login -->
        <div class="pm-row" style="gap:8px;flex-wrap:wrap">
          <input id="login-username" placeholder="Username" class="pm-input"/>
          <input id="login-password" placeholder="Master Password" type="password" class="pm-input"/>
          <button id="btn-login" class="pm-btn pm-btn-blue">Login</button>
        </div>

        <p id="pm-auth-msg" class="pm-msg"></p>
      </section>
    </div>
  </main>

<script type="module">
import {
  b64, ub64, pbkdf2Key, pbkdf2Bits,
  aesGcmEncryptJSON, aesGcmDecryptJSON, randomBytes
} from './js/crypto-utils.js';

// ====== CONFIG ======
const API = 'https://YOUR_RENDER_URL'; // e.g. https://srv-d40it2gdl3ps73bqt7j0.onrender.com

// ====== HELPERS ======
function msg(text, ok=false) {
  const el = document.getElementById('pm-auth-msg');
  el.textContent = text;
  el.style.color = ok ? 'green' : '';
}

// ====== REGISTER (with email verification) ======
async function onRegister() {
  try {
    const username = document.getElementById('reg-username').value.trim();
    const email    = document.getElementById('reg-email').value.trim();
    const password = document.getElementById('reg-password').value;

    if (!username || !email || !password) {
      msg('Please fill username, email, and password.');
      return;
    }

    // 1) generate salt and verifier (PBKDF2-HMAC-SHA256, per your utils)
    const salt = randomBytes(16);
    const verifierBits = await pbkdf2Bits(password, salt); // 256-bit
    const verifierB64  = b64(verifierBits);

    // 2) derive AES-GCM key for vault
    const vaultKey = await pbkdf2Key(password, salt);

    // 3) create empty vault and encrypt
    const emptyVault = { version: 1, entries: [] };
    const encVault = await aesGcmEncryptJSON(emptyVault, vaultKey); // {iv, ct}

    // 4) send to server
    const r = await fetch(`${API}/register`, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({
        username,
        email,
        salt: b64(salt),
        verifier: verifierB64,
        vault: encVault
      })
    });

    const data = await r.json().catch(()=> ({}));
    if (!r.ok) {
      msg(data.error || 'Registration failed.');
      return;
    }
    msg('Registration received. Check your email and click Activate.', true);
  } catch (e) {
    console.error(e);
    msg('Error during registration.');
  }
}

// ====== LOGIN (blocked until activated) ======
async function onLogin() {
  try {
    const username = document.getElementById('login-username').value.trim();
    const password = document.getElementById('login-password').value;
    if (!username || !password) {
      msg('Missing credentials.');
      return;
    }

    const r = await fetch(`${API}/login`, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ username })
    });

    const data = await r.json().catch(()=> ({}));
    if (r.status === 403) { msg('Account not activated. Check your email.'); return; }
    if (!r.ok) { msg(data.error || 'User not found.'); return; }

    // data: { username, email, salt, verifier, vault }
    const salt = ub64(data.salt);

    // PBKDF2 check
    const checkBits = await pbkdf2Bits(password, salt);
    if (b64(checkBits) !== data.verifier) {
      msg('Bad credentials.');
      return;
    }

    // decrypt vault (not shown after login, but we prove it works)
    const key = await pbkdf2Key(password, salt);
    await aesGcmDecryptJSON(data.vault, key); // throws if wrong

    // success â†’ go to main app page
    window.location.href = 'index.html';
  } catch (e) {
    console.error(e);
    msg('Login error.');
  }
}

// wire up buttons
document.getElementById('btn-register').addEventListener('click', onRegister);
document.getElementById('btn-login').addEventListener('click', onLogin);

// Optional banner if redirected after activation
if (location.hash === '#activated') {
  msg('Your account is activated. Please log in.', true);
}
</script>
</body>
</html>
