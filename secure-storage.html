<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Secure Storage</title>
  <link rel="stylesheet" href="css/secure.css" />
</head>
<body>
  <!-- Fixed nav (same style everywhere) -->
  <nav class="topnav">
    <div class="logo"><a href="index.html">Computer Components API</a></div>
    <ul>
      <li><a href="./sign-verify.html">Sign/Verify</a></li>
      <li><a href="ComputerComponentLIst.html">Computer Component List</a></li>
      <li><a href="ChartForJason.html">Chart Bar chart</a></li>
    </ul>
  </nav>

  <main class="secure-main">
    <header class="page-header">
      <h1>Secure Cloud Storage</h1>
      <p class="subtitle">
        Client-side encryption & decryption — your files never leave the browser unencrypted.
      </p>
    </header>

    <div class="tool-grid">
      <!-- ENCRYPT CARD -->
      <section class="tool-card">
        <h2>Encrypt <span class="badge">.secure</span></h2>

        <div class="field">
          <label for="ss-password">Password</label>
          <input type="password" id="ss-password" placeholder="Enter a strong password" />
          <small>Tip: use 12+ characters with symbols and numbers.</small>
        </div>

        <div class="field">
          <label for="ss-file">Select file to encrypt</label>
          <input type="file" id="ss-file" />
        </div>

        <div class="actions two">
          <button id="ss-encrypt-download" class="btn btn-green">Encrypt & Download</button>
          <button id="ss-encrypt-upload" class="btn btn-blue">Encrypt & Upload</button>
        </div>

        <div id="ss-log" class="result-box" aria-live="polite"></div>
      </section>

      <!-- DECRYPT CARD -->
      <section class="tool-card">
        <h2>Decrypt <span class="badge">.secure</span></h2>

        <div class="field">
          <label for="ss-password-dec">Password</label>
          <input type="password" id="ss-password-dec" placeholder="Password used at encryption" />
          <small>Tip: use 12+ characters with symbols and numbers.</small>
        </div>

        <div class="field">
          <label for="ss-secure">Select a local .secure file</label>
          <input type="file" id="ss-secure" accept=".secure" />
        </div>

        <div class="field">
          <label for="ss-remote-id">Or fetch from server by ID</label>
          <input type="text" id="ss-remote-id" placeholder="Paste ID you received after upload…" />
          <small>We’ll download the encrypted blob and decrypt it locally.</small>
        </div>

        <div class="actions two">
          <button id="ss-decrypt-local" class="btn btn-green">Decrypt Local</button>
          <button id="ss-fetch-decrypt" class="btn btn-blue">Fetch & Decrypt</button>
        </div>

        <div id="ss-output" class="result-box"></div>
      </section>
    </div>
  </main>

  <script type="module">
    import {
      b64, ub64, enc,
      randomBytes, deriveEncAndMac,
      aesGcmEncryptBytes, aesGcmDecryptBytes,
      exportRawKey, importRawAesKey,
      concatBytes, hmac, hmacVerify, download
    } from './js/crypto-utils.js';

    // ================================
    // CHANGE THIS TO YOUR DEPLOYED API
    // e.g. "https://pm-server-demo.onrender.com"
    // (or your new secure-storage API base)
    // ================================
    const API_BASE = "https://YOUR-RENDER-APP.onrender.com";

    const logEl   = document.getElementById('ss-log');
    const outEl   = document.getElementById('ss-output');

    const pwEnc   = document.getElementById('ss-password');
    const fileEnc = document.getElementById('ss-file');

    const pwDec   = document.getElementById('ss-password-dec');
    const fileDec = document.getElementById('ss-secure');
    const idDec   = document.getElementById('ss-remote-id');

    function log(msg) {
      logEl.textContent += (logEl.textContent ? "\n" : "") + msg;
      logEl.scrollTop = logEl.scrollHeight;
    }
    function out(msg) {
      outEl.textContent = msg;
    }

    // Build .secure package from a File
    async function buildSecurePackage(password, file) {
      const salt = randomBytes(16);
      const { aesKey, macKey } = await deriveEncAndMac(password, salt);

      // Generate a fresh symmetric key to encrypt the file
      const fileKey    = await crypto.subtle.generateKey({ name: 'AES-GCM', length: 256 }, true, ['encrypt', 'decrypt']);
      const rawFileKey = await exportRawKey(fileKey);

      // Encrypt file bytes
      const buf = new Uint8Array(await file.arrayBuffer());
      const { iv, ciphertext } = await aesGcmEncryptBytes(buf, fileKey);

      // Envelope encrypt the file key using AES key derived from password
      const encKey = await aesGcmEncryptBytes(rawFileKey, aesKey);

      // HMAC(version|salt|iv|ciphertext|key_iv|key_ct)
      const toMac = concatBytes(enc.encode('v1'), salt, iv, ciphertext, encKey.iv, encKey.ciphertext);
      const tag = await hmac(macKey, toMac);

      const pkg = {
        v: '1',
        name: file.name,
        mime: file.type,
        salt: b64(salt),
        iv: b64(iv),
        ciphertext: b64(ciphertext),
        key_iv: b64(encKey.iv),
        key_ct: b64(encKey.ciphertext),
        hmac: b64(tag)
      };
      const bytes = enc.encode(JSON.stringify(pkg));
      return { bytes, filename: `${file.name}.secure` };
    }

    // Encrypt & Download
    document.getElementById('ss-encrypt-download').addEventListener('click', async () => {
      const pw   = pwEnc.value;
      const file = fileEnc.files[0];
      if (!pw || !file) { log('Password and file required.'); return; }

      try {
        const { bytes, filename } = await buildSecurePackage(pw, file);
        download(filename, bytes);
        log(`Encrypted ${file.name} → ${filename} (downloaded)`);
      } catch (e) {
        log(`Error: ${e.message}`);
      }
    });

    // Encrypt & Upload
    document.getElementById('ss-encrypt-upload').addEventListener('click', async () => {
      const pw   = pwEnc.value;
      const file = fileEnc.files[0];
      if (!pw || !file) { log('Password and file required.'); return; }

      try {
        const { bytes, filename } = await buildSecurePackage(pw, file);

        const form = new FormData();
        form.append('file', new Blob([bytes], { type: 'application/octet-stream' }), filename);

        const resp = await fetch(`${API_BASE}/secure/upload`, { method: 'POST', body: form });
        if (!resp.ok) throw new Error('Upload failed');
        const { id } = await resp.json();

        log(`Uploaded as ID: ${id}`);
        log(`Download URL: ${API_BASE}/secure/download/${id}`);
      } catch (e) {
        log(`Upload error: ${e.message}`);
      }
    });

    // Common decrypt function (given the serialized .secure string)
    async function decryptFromText(password, text) {
      const pkg  = JSON.parse(text);
      const salt = ub64(pkg.salt),
            iv   = ub64(pkg.iv),
            ct   = ub64(pkg.ciphertext),
            kiv  = ub64(pkg.key_iv),
            kct  = ub64(pkg.key_ct);

      const { aesKey, macKey } = await deriveEncAndMac(password, salt);

      // Verify HMAC
      const toMac = concatBytes(enc.encode('v1'), salt, iv, ct, kiv, kct);
      const ok    = await hmacVerify(macKey, toMac, ub64(pkg.hmac));
      if (!ok) throw new Error('Integrity check failed (bad password or tampered file)');

      // Decrypt file key, then file
      const rawFileKey = await aesGcmDecryptBytes(kiv, kct, aesKey);
      const fileKey    = await importRawAesKey(rawFileKey);
      const pt         = await aesGcmDecryptBytes(iv, ct, fileKey);

      // Save result
      const blob = new Blob([pt], { type: pkg.mime || 'application/octet-stream' });
      const url  = URL.createObjectURL(blob);
      const a    = document.createElement('a');
      a.href     = url;
      a.download = pkg.name || 'decrypted.bin';
      a.click();
      URL.revokeObjectURL(url);

      out(`Decrypted: ${pkg.name || 'file'}`);
    }

    // Decrypt local file
    document.getElementById('ss-decrypt-local').addEventListener('click', async () => {
      const pw = pwDec.value;
      const f  = fileDec.files[0];
      if (!pw || !f) { alert('Password and .secure file required'); return; }

      try {
        const text = await f.text();
        await decryptFromText(pw, text);
      } catch (e) {
        alert(e.message);
      }
    });

    // Fetch & Decrypt by server ID
    document.getElementById('ss-fetch-decrypt').addEventListener('click', async () => {
      const pw = pwDec.value;
      const id = (idDec.value || '').trim();
      if (!pw || !id) { alert('Password and ID required'); return; }

      try {
        const resp = await fetch(`${API_BASE}/secure/download/${encodeURIComponent(id)}`);
        if (!resp.ok) throw new Error('Could not fetch file from server');
        const blob = await resp.blob();
        const text = await blob.text();
        await decryptFromText(pw, text);
      } catch (e) {
        alert(e.message);
      }
    });
  </script>
</body>
</html>